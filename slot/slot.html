<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üé∞ –°–ª–æ—Ç –ú–∞—à–∏–Ω–∞</title>
  <style>
    :root { --reel-w: 140px; --reel-h: 140px; --gap: 18px; }
    body{
      background:#111;
      color:#fff;
      font-family: Arial, Helvetica, sans-serif;
      text-align:center;
      padding:30px;
    }
    h1{ margin:4px 0 16px; }

    .machine{ display:flex; justify-content:center; gap:var(--gap); margin-top:10px; }
    .reel{
      width:var(--reel-w);
      height:var(--reel-h);
      border:3px solid #fff;
      border-radius:12px;
      background:#222;
      overflow:hidden;
      position:relative;
      box-shadow:0 6px 18px rgba(0,0,0,.6);
    }

    /* –¥–æ—Ä–æ–∂–∫–∞, –∫–æ—Ç–æ—Ä—É—é –±—É–¥–µ–º —Å–¥–≤–∏–≥–∞—Ç—å */
    .track{
      position:absolute;
      left:0;
      top:0;
      width:100%;
      will-change: transform;
    }
    .track img{
      display:block;
      width:100%;
      height:var(--reel-h);
      object-fit:contain;
      user-select:none;
      pointer-events:none;
    }

    #spin{
      margin-top:20px;
      padding:10px 18px;
      font-size:16px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      background:#fff;
      color:#000;
    }
    #spin:disabled{ opacity:.5; cursor:not-allowed; }

    #result{ margin-top:18px; font-size:18px; min-height:1.2em; }

    @media (max-width:520px){
      :root{ --reel-w:110px; --reel-h:110px; --gap:12px; }
    }
  </style>
</head>
<body>
  <h1>üé∞ –°–ª–æ—Ç –ú–∞—à–∏–Ω–∞</h1>

  <div class="machine">
    <div class="reel" id="r0"></div>
    <div class="reel" id="r1"></div>
    <div class="reel" id="r2"></div>
  </div>

  <button id="spin">–ö—Ä—É—Ç–∏—Ç—å!</button>
  <div id="result"></div>

  <script>
    /***************** –ù–∞—Å—Ç—Ä–æ–π–∫–∏ *****************/
    const JSON_PATH = "./Cards.json";      // —Ñ–∞–π–ª —Ä—è–¥–æ–º —Å —ç—Ç–∏–º HTML
    const REPEAT = 8;                      // —Å–∫–æ–ª—å–∫–æ —Å–ª—É—á–∞–π–Ω—ã—Ö –∫–∞—Ä—Ç –ø–µ—Ä–µ–¥ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π
    const BASE_DURATION = 1200;            // –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è 1-–≥–æ –±–∞—Ä–∞–±–∞–Ω–∞ (–º—Å)
    const STEP_DURATION = 900;             // –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ (–º—Å)
    const BUFFER_AFTER = 120;              // –±—É—Ñ–µ—Ä –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π (–º—Å)
    /*********************************************/

    const reels = [document.getElementById("r0"), document.getElementById("r1"), document.getElementById("r2")];
    const spinBtn = document.getElementById("spin");
    const resultEl = document.getElementById("result");
    let images = []; // –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫-URL

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è JSON (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å—Ç—Ä–æ–∫–∏ –∏ –æ–±—ä–µ–∫—Ç—ã)
    async function loadCards() {
      try {
        // –ü—Ä–æ–±–ª–µ–º–∞: fetch –∏–∑ file:// —á–∞—Å—Ç–æ –ø–∞–¥–∞–µ—Ç. –ü–æ–∫–∞–∂–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É.
        if (location.protocol === "file:") {
          resultEl.textContent = "‚ö†Ô∏è –í—ã –æ—Ç–∫—Ä—ã–ª–∏ —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É—é (file://). –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (—Å–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤–Ω–∏–∑—É).";
        }

        const res = await fetch(JSON_PATH);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const raw = await res.json();
        if (!Array.isArray(raw)) throw new Error("Cards.json –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º");
        images = raw.map(item => {
          if (typeof item === "string") return item;
          if (item && typeof item === "object") {
            return item.url || item.image || item.img || item.src || "";
          }
          return "";
        }).filter(Boolean);

        if (images.length === 0) {
          resultEl.textContent = "‚ö†Ô∏è Cards.json –ø—É—Å—Ç –∏–ª–∏ –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.";
          spinBtn.disabled = true;
        } else {
          // –ø–æ–∫–∞–∂–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ —Å–ª—É—á–∞–π–Ω—ã–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏
          reels.forEach((r, i) => {
            r.innerHTML = `<img src="${images[Math.floor(Math.random()*images.length)]}" alt="">`;
          });
        }
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Cards.json:", err);
        resultEl.textContent = "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å Cards.json ‚Äî —Å–º. –∫–æ–Ω—Å–æ–ª—å.";
        spinBtn.disabled = true;
      }
    }

    // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π URL
    function randUrl() {
      return images[Math.floor(Math.random()*images.length)];
    }

    // –°–æ–∑–¥–∞—ë—Ç –¥–æ—Ä–æ–∂–∫—É (track) –≤–Ω—É—Ç—Ä–∏ reel, –∑–∞–ø–æ–ª–Ω—è–µ—Ç REPEAT —Å–ª—É—á–∞–π–Ω—ã—Ö + final, –∂–¥—ë—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç {track, totalShift}
    function buildTrack(reelEl, finalUrl) {
      return new Promise((resolve) => {
        // –æ—á–∏—Å—Ç–∫–∞
        reelEl.innerHTML = "";

        const track = document.createElement("div");
        track.className = "track";

        // –¥–æ–±–∞–≤–ª—è–µ–º REPEAT —Å–ª—É—á–∞–π–Ω—ã—Ö –∫–∞—Ä—Ç
        for (let k = 0; k < REPEAT; k++) {
          const img = document.createElement("img");
          img.src = randUrl();
          track.appendChild(img);
        }
        // –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É (–≤ –∫–æ–Ω—Ü–µ)
        const finalImg = document.createElement("img");
        finalImg.src = finalUrl;
        finalImg.dataset.final = "1";
        track.appendChild(finalImg);

        reelEl.appendChild(track);

        // –∂–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö <img> –≤ track ( –Ω–æ –Ω–µ –∑–∞–≤–∏—Å–∞–µ–º –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫ ‚Äî —Å—á–∏—Ç–∞–µ–º –∑–∞–≥—Ä—É–∑–∫–æ–π –∏ –æ—à–∏–±–∫—É )
        const imgs = Array.from(track.querySelectorAll("img"));
        let loaded = 0;
        function checkDone() {
          loaded++;
          if (loaded >= imgs.length) {
            // –≤—ã—á–∏—Å–ª—è–µ–º, –Ω–∞ —Å–∫–æ–ª—å–∫–æ —Å–¥–≤–∏–Ω—É—Ç—å –¥–æ—Ä–æ–∂–∫—É, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç –≤—Å—Ç–∞–ª –≤ –≤–∏–¥–∏–º–æ–π –∑–æ–Ω–µ
            const trackHeight = track.scrollHeight;
            const viewH = reelEl.clientHeight;
            const totalShift = Math.max(0, trackHeight - viewH); // px
            resolve({ track, totalShift });
          }
        }
        if (imgs.length === 0) {
          resolve({ track, totalShift: 0 });
        } else {
          imgs.forEach(img => {
            if (img.complete) {
              checkDone();
            } else {
              img.addEventListener("load", checkDone);
              img.addEventListener("error", checkDone);
            }
          });
        }
      });
    }

    // –ó–∞–ø—É—Å–∫ —Å–ø–∏–Ω–∞
    async function spin() {
      if (!images.length) {
        resultEl.textContent = "‚è≥ –°—Å—ã–ª–∫–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å...";
        return;
      }

      spinBtn.disabled = true;
      resultEl.textContent = "";

      // –≤—ã–±–µ—Ä–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ URL –∑–∞—Ä–∞–Ω–µ–µ (–≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ —Ñ–∏–Ω–∞–ª—ã –±—É–¥—É—Ç –≤–∏–¥–Ω—ã –≤ –∫–æ–Ω—Ü–µ)
      const finals = [randUrl(), randUrl(), randUrl()];

      // —Å—Ç—Ä–æ–∏–º –¥–æ—Ä–æ–∂–∫–∏ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
      const buildPromises = reels.map((r, i) => buildTrack(r, finals[i]));
      const built = await Promise.all(buildPromises); // –º–∞—Å—Å–∏–≤ {track, totalShift}

      // –ù–∞—Å—Ç—Ä–æ–∏–º –∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å—Ç–∞—Ä—Ç—É–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏, –Ω–æ —Å —Ä–∞–∑–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é, —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª–∏—Å—å –ø–æ –æ—á–µ—Ä–µ–¥–∏
      built.forEach(({ track, totalShift }, i) => {
        const duration = BASE_DURATION + i * STEP_DURATION; // ms
        // —Å–±—Ä–æ—Å: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–µ—Ä—Ö (–Ω–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è ‚Äî 0)
        track.style.transition = "none";
        track.style.transform = `translateY(0px)`;

        // –Ω–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä –ø—Ä–∏–º–µ–Ω–∏–ª —Å—Ç–∏–ª—å
        setTimeout(() => {
          // –≤–∫–ª—é—á–∞–µ–º transition —Å –Ω—É–∂–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∏ –¥–≤–∏–≥–∞–µ–º track –≤–≤–µ—Ä—Ö, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç –æ–∫–∞–∑–∞–ª—Å—è –≤–∏–¥–∏–º—ã–º
          track.style.transition = `transform ${duration}ms cubic-bezier(0.22,1,0.36,1)`;
          track.style.transform = `translateY(-${totalShift}px)`;
        }, 30);
      });

      // –∂–¥—ë–º –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–∞–º–æ–π –¥–ª–∏–Ω–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏ + –Ω–µ–±–æ–ª—å—à–æ–π –±—É—Ñ–µ—Ä
      const lastDuration = BASE_DURATION + (reels.length - 1) * STEP_DURATION;
      await new Promise(res => setTimeout(res, lastDuration + BUFFER_AFTER));

      // –ø—Ä–æ–≤–µ—Ä–∫–∞: —Å—Ä–∞–≤–Ω–∏–º final URLs
      const win = finals[0] && finals[0] === finals[1] && finals[1] === finals[2];
      if (win) {
        resultEl.textContent = "üéâ –í—ã–∏–≥—Ä–∞–ª–∏!";
      } else {
        resultEl.textContent = "–ü—Ä–æ–µ–±–∞–ª–∏?";
      }
      spinBtn.disabled = false;
    }

    spinBtn.addEventListener("click", spin);

    // —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
    loadCards();
  </script>

  <!--
    –ï—Å–ª–∏ –≤—ã –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ –ª–æ–∫–∞–ª—å–Ω–æ –∏ –≤–∏–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ file:// ‚Äî –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ—Å—Ç–æ–π —Å–µ—Ä–≤–µ—Ä –≤ –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞:
      Python 3:
        python -m http.server 8000
      –∏–ª–∏ (–µ—Å–ª–∏ —É –≤–∞—Å npm):
        npx serve .
      –ó–∞—Ç–µ–º –æ—Ç–∫—Ä–æ–π—Ç–µ:
        http://localhost:8000/slot/slot.html
  -->
</body>
</html>
