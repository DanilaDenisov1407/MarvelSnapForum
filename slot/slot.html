<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üé∞ –°–ª–æ—Ç –ú–∞—à–∏–Ω–∞</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    body{
      background:#111;
      color:#fff;
      font-family: Arial, Helvetica, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align:center;
      padding: 20px;
      box-sizing: border-box;
    }

    h1{ margin:4px 0 16px; }

    /* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∞ */
    .machine-container {
      position: relative;
      width: 90vw;
      max-width: 920px;
      aspect-ratio: 1200 / 900; /* —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ */
    }

    /* —Ä–∞–º–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∞ */
    .slot-frame{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:none;
      user-select:none;
      object-fit:contain;
    }

    /* –±–∞—Ä–∞–±–∞–Ω—ã */
    .reel{
      position:absolute;
      border:none;
      background:transparent;
      overflow:hidden;
      box-shadow:none;
    }

    /* —Ç—Ä–µ–∫ —Å –∫–∞—Ä—Ç–∞–º–∏ */
    .track{ position:absolute; left:0; top:-110px; width:100%; will-change: transform; } /* –ø–æ–¥–Ω–∏–º–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–∞ 110px */
    .track img{ display:block; width:100%; height:100%; object-fit:contain; user-select:none; pointer-events:none; }

    /* –ü–æ–∑–∏—Ü–∏–∏ –±–∞—Ä–∞–±–∞–Ω–æ–≤ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö (–ø–æ–¥ –æ–∫–Ω–∞ –≤ svg) */
    #r0{ left:19.17%; top:40%; width:18.33%; height:35.56%; }
    #r1{ left:40.83%; top:40%; width:18.33%; height:35.56%; }
    #r2{ left:62.50%; top:40%; width:18.33%; height:35.56%; }

    #spin{
      margin-top:20px;
      padding:10px 18px;
      font-size:16px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      background:#fff;
      color:#000;
    }
    #spin:disabled{ opacity:.5; cursor:not-allowed; }

    #result{ margin-top:18px; font-size:18px; min-height:1.2em; }

    @media (max-width:520px){
      .machine-container{ width: 98vw; }
    }
  </style>
</head>
<body>
  <h1>üé∞ –°–ª–æ—Ç –ú–∞—à–∏–Ω–∞</h1>

  <div class="machine-container machine">
    <!-- SVG-—Ä–∞–º–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∞ -->
    <img class="slot-frame" src="slot-frame.svg" alt="slot frame" />
    <!-- —Ç—Ä–∏ –±–∞—Ä–∞–±–∞–Ω–∞ -->
    <div class="reel" id="r0"></div>
    <div class="reel" id="r1"></div>
    <div class="reel" id="r2"></div>
  </div>

  <button id="spin">–ö—Ä—É—Ç–∏—Ç—å!</button>
  <div id="result"></div>

  <script>
    /***************** –ù–∞—Å—Ç—Ä–æ–π–∫–∏ *****************/
    const JSON_PATH = "./Cards.json";      // —Ñ–∞–π–ª —Ä—è–¥–æ–º —Å —ç—Ç–∏–º HTML
    const REPEAT = 8;                      // —Å–∫–æ–ª—å–∫–æ —Å–ª—É—á–∞–π–Ω—ã—Ö –∫–∞—Ä—Ç –ø–µ—Ä–µ–¥ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π
    const BASE_DURATION = 1200;            // –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è 1-–≥–æ –±–∞—Ä–∞–±–∞–Ω–∞ (–º—Å)
    const STEP_DURATION = 900;             // –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ (–º—Å)
    const BUFFER_AFTER = 120;              // –±—É—Ñ–µ—Ä –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π (–º—Å)
    /*********************************************/

    const reels = [document.getElementById("r0"), document.getElementById("r1"), document.getElementById("r2")];
    const spinBtn = document.getElementById("spin");
    const resultEl = document.getElementById("result");
    let images = []; // –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫-URL

    async function loadCards() {
      try {
        if (location.protocol === "file:") {
          resultEl.textContent = "‚ö†Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç–µ —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä, –∞ –Ω–µ file://";
        }
        const res = await fetch(JSON_PATH);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const raw = await res.json();
        if (!Array.isArray(raw)) throw new Error("Cards.json –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º");
        images = raw.map(item => {
          if (typeof item === "string") return item;
          if (item && typeof item === "object") {
            return item.url || item.image || item.img || item.src || "";
          }
          return "";
        }).filter(Boolean);

        if (images.length === 0) {
          resultEl.textContent = "‚ö†Ô∏è Cards.json –ø—É—Å—Ç –∏–ª–∏ –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.";
          spinBtn.disabled = true;
        } else {
          reels.forEach(r => {
            r.innerHTML = `<img src="${images[Math.floor(Math.random()*images.length)]}" alt="">`;
          });
        }
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Cards.json:", err);
        resultEl.textContent = "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å Cards.json";
        spinBtn.disabled = true;
      }
    }

    function randUrl() {
      return images[Math.floor(Math.random()*images.length)];
    }

    function buildTrack(reelEl, finalUrl) {
      return new Promise((resolve) => {
        reelEl.innerHTML = "";
        const track = document.createElement("div");
        track.className = "track";
        for (let k = 0; k < REPEAT; k++) {
          const img = document.createElement("img");
          img.src = randUrl();
          track.appendChild(img);
        }
        const finalImg = document.createElement("img");
        finalImg.src = finalUrl;
        finalImg.dataset.final = "1";
        track.appendChild(finalImg);
        reelEl.appendChild(track);

        const imgs = Array.from(track.querySelectorAll("img"));
        let loaded = 0;
        function checkDone() {
          loaded++;
          if (loaded >= imgs.length) {
            const trackHeight = track.scrollHeight;
            const viewH = reelEl.clientHeight;
            const totalShift = Math.max(0, trackHeight - viewH);
            resolve({ track, totalShift });
          }
        }
        if (imgs.length === 0) {
          resolve({ track, totalShift: 0 });
        } else {
          imgs.forEach(img => {
            if (img.complete) checkDone();
            else {
              img.addEventListener("load", checkDone);
              img.addEventListener("error", checkDone);
            }
          });
        }
      });
    }

    async function spin() {
      if (!images.length) {
        resultEl.textContent = "‚è≥ –°—Å—ã–ª–∫–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å...";
        return;
      }
      spinBtn.disabled = true;
      resultEl.textContent = "";

      const finals = [randUrl(), randUrl(), randUrl()];
      const buildPromises = reels.map((r, i) => buildTrack(r, finals[i]));
      const built = await Promise.all(buildPromises);

      built.forEach(({ track, totalShift }, i) => {
        const duration = BASE_DURATION + i * STEP_DURATION;
        track.style.transition = "none";
        track.style.transform = `translateY(0px)`;
        setTimeout(() => {
          track.style.transition = `transform ${duration}ms cubic-bezier(0.22,1,0.36,1)`;
          track.style.transform = `translateY(-${totalShift}px)`;
        }, 30);
      });

      const lastDuration = BASE_DURATION + (reels.length - 1) * STEP_DURATION;
      await new Promise(res => setTimeout(res, lastDuration + BUFFER_AFTER));

      const win = finals[0] && finals[0] === finals[1] && finals[1] === finals[2];
      resultEl.textContent = win ? "üéâ –í—ã–∏–≥—Ä–∞–ª–∏!" : "–ü—Ä–æ–µ–±–∞–ª–∏?";
      spinBtn.disabled = false;
    }

    spinBtn.addEventListener("click", spin);
    loadCards();
  </script>
</body>
</html>
