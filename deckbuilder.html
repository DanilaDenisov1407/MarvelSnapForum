<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Коллаж + Save</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:#1a0e3c;color:#fff;font-family:'Segoe UI',sans-serif;min-height:100vh}
    .top-bar{display:flex;justify-content:space-between;align-items:center;padding:10px 20px}
    .btn-group{display:flex;gap:10px}
    button{border:none;border-radius:4px;padding:8px 14px;font-size:14px;cursor:pointer;color:#fff}
    .btn-save{background:#00cc66}
    .btn-reset{background:#e60000}
    .btn-copy{background:#3399ff}
    .btn-import{background:#cc33ff}
    .main{display:flex;gap:40px;padding:20px;flex-wrap:wrap;justify-content:center}
    .deck-grid{display:grid;grid-template-columns:repeat(4,80px);grid-template-rows:repeat(3,120px);gap:10px}
    .card-slot{width:80px;height:120px;background:rgba(255,255,255,0.1);border:2px solid rgba(255,255,255,0.2);border-radius:4px;overflow:hidden}
    .card-slot img{width:100%;height:100%;object-fit:cover}
    .breakdown{display:flex;flex-direction:column;gap:30px;font-size:14px}
    .break{width:140px}
    .break h3{display:flex;align-items:center;gap:6px;font-size:16px;margin-bottom:8px}
    .break h3 span{display:inline-flex;justify-content:center;align-items:center;width:24px;height:24px;background:#00aaff;border-radius:50%;font-size:12px}
    .break-chart{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;align-items:flex-end;height:100px}
    .break-chart div{background:#ff8c00;border-radius:3px;position:relative;transition:height .3s}
    .break-chart div::after{content:attr(data-label);position:absolute;bottom:-18px;left:50%;transform:translateX(-50%);font-size:12px;color:#ddd}
    @media(max-width:900px){.main{flex-direction:column;align-items:center}.breakdown{flex-direction:row;justify-content:center}}
  </style>
</head>
<body>
  <div class="top-bar">
    <div class="btn-group">
      <button id="btnSave" class="btn-save">Save</button>
      <button id="btnReset" class="btn-reset">Reset</button>
      <button id="btnCopy" class="btn-copy">Copy Code</button>
    </div>
    <div class="btn-group">
      <button id="btnImport" class="btn-import">Import Deck Code</button>
    </div>
  </div>

  <script>
    let lastCode = '';
    let cardsDb = [];
    fetch('./marvelsnapzone.com.json')
      .then(r => r.json())
      .then(d => cardsDb = d.success.cards || [])
      .catch(console.error);

    function updateBreakdown(cards) {
      const costCounts = Array(7).fill(0),
            powerCounts = Array(7).fill(0);
      cards.forEach(c => {
        const e = cardsDb.find(x => x.carddefid === c.CardDefId);
        if (!e) return;
        if (e.cost  >= 0 && e.cost  <= 6) costCounts[e.cost]++;
        if (e.power >= 0 && e.power <= 6) powerCounts[e.power]++;
      });
      document.getElementById('totalCards').textContent  = cards.length;
      document.getElementById('totalCards2').textContent = cards.length;
      const maxCost  = Math.max(...costCounts,1),
            maxPower = Math.max(...powerCounts,1);
      Array.from(document.getElementById('costChart').children)
        .forEach((b,i) => { b.style.height = (costCounts[i]/maxCost*100)+'px'; b.title = costCounts[i] });
      Array.from(document.getElementById('powerChart').children)
        .forEach((b,i) => { b.style.height = (powerCounts[i]/maxPower*100)+'px'; b.title = powerCounts[i] });
    }

    function loadDeckFromCode(b64) {
      let obj;
      try { obj = JSON.parse(atob(b64)); }
      catch { return alert('Неверный Base64/JSON'); }
      const cards = obj.Cards || [];
      lastCode = b64;
      document.querySelectorAll('.card-slot').forEach(s => s.innerHTML = '');
      cards.slice(0,12).forEach((c,i) => {
        const e = cardsDb.find(x => x.carddefid === c.CardDefId);
        if (!e) return;
        const img = new Image();
        img.src = 'static/downloaded_cards/' + encodeURIComponent(e.name) + '/art.webp';
        img.onerror = () => {};
        document.querySelectorAll('.card-slot')[i].appendChild(img);
      });
      updateBreakdown(cards.slice(0,12));
    }

    document.getElementById('btnImport').onclick = () => {
      const code = prompt('Вставьте Base64-код:');
      if (code) loadDeckFromCode(code.trim());
    };
    document.getElementById('btnReset').onclick = () => {
      document.querySelectorAll('.card-slot').forEach(s => s.innerHTML = '');
      updateBreakdown([]); lastCode = '';
    };
    document.getElementById('btnCopy').onclick = () => {
      if (!lastCode) return alert('Нечего копировать');
      navigator.clipboard.writeText(lastCode).then(() => alert('Код скопирован')).catch(() => alert('Ошибка копирования'));
    };

    function roundRect(ctx,x,y,w,h,r){
      ctx.beginPath(); ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y);
      ctx.quadraticCurveTo(x+w,y,x+w,y+r); ctx.lineTo(x+w,y+h-r);
      ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h); ctx.lineTo(x+r,y+h);
      ctx.quadraticCurveTo(x,y+h,x,y+h-r); ctx.lineTo(x,y+r);
      ctx.quadraticCurveTo(x,y,x+r,y); ctx.closePath(); ctx.stroke();
    }

    document.getElementById('btnSave').onclick = () => {
      const g = document.getElementById('deckGrid'),
            b = document.querySelector('.breakdown'),
            p = 20, s = 40,
            gw = g.offsetWidth, gh = g.offsetHeight,
            bw = b.offsetWidth, bh = b.offsetHeight,
            cW = 2*p + gw + s + bw,
            cH = 2*p + Math.max(gh, bh),
            scale = 2,
            cn = document.createElement('canvas');
      cn.width = cW * scale; cn.height = cH * scale;
      const ctx = cn.getContext('2d');
      ctx.scale(scale, scale);
      ctx.fillStyle = '#1a0e3c';
      ctx.fillRect(0, 0, cW, cH);

      const gap = 10, sw = 80, sh = 120;
      document.querySelectorAll('.card-slot').forEach((slot, i) => {
        const img = slot.querySelector('img');
        if (!img || !img.complete) return;
        const col = i % 4, row = Math.floor(i / 4),
              x = p + col * (sw + gap), y = p + row * (sh + gap);
        ctx.drawImage(img, x, y, sw, sh);
        ctx.strokeStyle = 'rgba(255,255,255,0.2)';
        ctx.lineWidth = 2;
        roundRect(ctx, x, y, sw, sh, 4);
      });

      function drawSec(title, totalId, chartId, offY) {
        const cx = p + gw + s, cy = p + offY;
        ctx.fillStyle = '#00aaff'; ctx.beginPath();
        ctx.arc(cx, cy + 12, 12, 0, 2 * Math.PI); ctx.fill();
        ctx.fillStyle = '#fff'; ctx.font = '12px sans-serif';
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText(document.getElementById(totalId).textContent, cx, cy + 12);
        ctx.textAlign = 'left'; ctx.font = '16px sans-serif';
        ctx.fillText(title, cx + 18, cy + 14);
        const chart = document.getElementById(chartId),
              bars = chart.children,
              ch = chart.clientHeight,
              cw = chart.offsetWidth,
              gapC = parseInt(getComputedStyle(chart).gap) || 4,
              barW = (cw - gapC * (bars.length - 1)) / bars.length,
              chartY = cy + 36;
        for (let i = 0; i < bars.length; i++) {
          const h = parseFloat(bars[i].style.height),
                x = cx + i * (barW + gapC),
                y = chartY + (ch - h);
          ctx.fillStyle = '#ff8c00'; ctx.fillRect(x, y, barW, h);
          ctx.fillStyle = '#ddd'; ctx.font = '12px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(i, x + barW / 2, chartY + ch + 12);
        }
      }

      drawSec('Cost Breakdown', 'totalCards', 'costChart', 0);
      drawSec('Power Breakdown', 'totalCards2', 'powerChart', 152);

      cn.toBlob(blob => {
        const a = document.createElement('a');
        a.download = 'collage_hd.png';
        a.href = URL.createObjectURL(blob);
        a.click();
      });
    };
  </script>

  <div class="main">
    <div class="deck-grid" id="deckGrid">
      <div class="card-slot"></div><div class="card-slot"></div><div class="card-slot"></div><div class="card-slot"></div>
      <div class="card-slot"></div><div class="card-slot"></div><div class="card-slot"></div><div class="card-slot"></div>
      <div class="card-slot"></div><div class="card-slot"></div><div class="card-slot"></div><div class="card-slot"></div>
    </div>
    <div class="breakdown">
      <div class="break">
        <h3><span id="totalCards">0</span> Cost Breakdown</h3>
        <div class="break-chart" id="costChart">
          <div data-label="0"></div><div data-label="1"></div><div data-label="2"></div>
          <div data-label="3"></div><div data-label="4"></div><div data-label="5"></div>
          <div data-label="6"></div>
        </div>
      </div>
      <div class="break">
        <h3><span id="totalCards2">0</span> Power Breakdown</h3>
        <div class="break-chart" id="powerChart">
          <div data-label="0"></div><div data-label="1"></div><div data-label="2"></div>
          <div data-label="3"></div><div data-label="4"></div><div data-label="5"></div>
          <div data-label="6"></div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
