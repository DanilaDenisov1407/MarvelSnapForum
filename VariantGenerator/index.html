<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Card Generator ‚Äî fixed</title>

  <style>
    /* ===== Reset ===== */
    *{box-sizing:border-box;padding:0;margin:0}
    html,body{height:100%;}

    @font-face{font-family:'Roboto';font-style:normal;font-weight:900;src:url('fonts/Roboto-Black.ttf') format('truetype')}
    @font-face{font-family:'Comicraft';font-style:italic;font-weight:900;src:url('fonts/Comicraft-CCUltimatum-Bold-Italic.woff2') format('woff2')}

    :root{
      --container-padding:25px;
      --container-border-width:5px;
      --container-border-radius:20px;
      --container-gap:10px;
      --image-min-height:330px;
      --rarity-padding-y:5px;
      --rarity-padding-x:15px;
      --rarity-font-size:16px;
      --rarity-border-width:6px;
      --rarity-border-radius:15px;
      --author-font-size:18px;
      --cost-gap:5px;
      --price-font-size:18px;
      --cost-font-size:18px;
      --icon-width:20px;
      --icon-height:20px;
      --telegram-font-size:18px;

      /* scaled */
      --scaled-container-border-width:10px;
      --scaled-container-border-radius:40px;
      --scaled-container-padding:20px;
      --scaled-container-gap:10px;
      --scaled-rarity-padding-y:8px;
      --scaled-rarity-padding-x:25px;
      --scaled-rarity-font-size:30px;
      --scaled-rarity-border-width:10px;
      --scaled-rarity-border-radius:25px;
      --scaled-rarity-text-shadow-x:1.7px;
      --scaled-rarity-text-shadow-y:1.7px;
      --scaled-author-font-size:36px;
      --scaled-cost-gap:10px;
      --scaled-cost-font-size:30px;
      --scaled-price-font-size:36px;
      --scaled-icon-width:40px;
      --scaled-icon-height:40px;
      --scaled-telegram-font-size:36px;
      --scaled-image-min-height:560px;
    }

    body{
      background:#20252b;color:#fff;font-family:Roboto, sans-serif;font-weight:900;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;
    }
    .wrapper{display:flex;gap:20px;max-width:1200px;flex-wrap:wrap;}

    /* preview container */
    .preview-container{display:flex;flex-direction:column;gap:var(--container-gap);min-width:300px;max-width:360px;background:#000 url('img/9372e881397e867c7f2bca42c3fdd1e9.jpg') repeat; border:var(--container-border-width) solid #9801e7;border-radius:var(--container-border-radius);overflow:hidden;padding:var(--container-padding);position:relative;}
    .preview-image{width:100%;min-height:var(--image-min-height);object-fit:cover;}
    .preview-data{display:flex;flex-direction:column;align-items:center;gap:var(--container-gap);text-align:center;}
    .capture-data{display:flex;flex-direction:column;align-items:center;gap:var(--container-gap);text-align:center;width:100%;}

    /* rarity */
    .rarity-block{position:relative;display:inline-block;background:linear-gradient(180deg,#e800fe,#9500d0,#380274);color:#fff;padding:var(--rarity-padding-y) var(--rarity-padding-x);font-size:var(--rarity-font-size);text-transform:uppercase;transform:skew(-20deg);z-index:20;border:var(--rarity-border-width) solid transparent;border-top-right-radius:var(--rarity-border-radius);border-bottom-left-radius:var(--rarity-border-radius);}
    .rarity-block span{display:inline-block;font-family:Comicraft, sans-serif;font-weight:900;font-style:italic;transform:skew(15deg);text-shadow:1px 1px 0 rgba(0,0,0,0.5);}

    /* variants */
    .rarity-block.rare{background:linear-gradient(180deg,#e800fe,#9500d0,#380274);}
    .rarity-block.super-rare{background:linear-gradient(180deg,#69e0e4,#4cbcc7,#17596f);}
    .rarity-block.ultimate{background:linear-gradient(180deg,#db2a24,#a81b14,#680d0a);}
    .rarity-block.spotlight{background:linear-gradient(180deg,#0027d5,#0549f4,#041abd);}
    .rarity-block.conquest-reward{background:linear-gradient(180deg,#39d25a,#1a821a,#0e4f0e);}
    .rarity-block.bundle{background:linear-gradient(180deg,#fff2a6,#ffd700,#b89400); color:#fff;}
    .rarity-block.webshop-reward{background:linear-gradient(180deg,#ffb066,#db8216,#8a4b00);}

    .author-text{font-size:var(--author-font-size);}
    .cost-wrapper{display:flex;align-items:center;gap:var(--cost-gap);}
    .price-label{font-size:var(--price-font-size);}
    #costText{font-size:var(--cost-font-size);display:inline-block;}
    #iconImg, #captureIconImg{width:var(--icon-width);height:var(--icon-height);display:inline-block;image-rendering: pixelated;}

    .telegram-link{color:#7af5f0;font-size:var(--telegram-font-size);text-decoration:none;}

    /* controls */
    .controls {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }
    @media (max-width: 600px) {
      .controls {
        grid-template-columns: 1fr;
      }
    }
    .controls input,
    .controls button,
    .controls label,
    .controls select {
      padding: 10px 15px;   /* –ß—É—Ç—å –º–µ–Ω—å—à–µ, —á—Ç–æ–±—ã –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–ª–æ */
      font-size: 16px;      /* –û—Å—Ç–∞–≤–ª—è–µ–º 16px –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏ */
      width: 100%;          /* –†–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è –≤ —è—á–µ–π–∫–µ —Å–µ—Ç–∫–∏ */
      height: 50px;         /* üîπ –û–¥–∏–Ω–∞–∫–æ–≤–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –≤—Å–µ—Ö */
      line-height: 1.2;     /* –¢–µ–∫—Å—Ç –ø–æ —Ü–µ–Ω—Ç—Ä—É */
      box-sizing: border-box;
      font-family: Roboto;
      border: 2px solid #9801e7;
      background: #333;
      color: #fff;
      border-radius: 5px;
      display: flex;
      align-items: center;  /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ */
    }
    .custom-file-button {
      width: 100%;
      cursor: pointer;
      padding: 10px 15px;   /* –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ */
      font-size: 16px;
      height: 50px;         /* –û–¥–∏–Ω–∞–∫–æ–≤–∞—è –≤—ã—Å–æ—Ç–∞ */
      line-height: 1.2;
      box-sizing: border-box;
      font-family: Roboto;
      border: 2px solid #9801e7;
      background: #333;
      color: #fff;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .input-value {
      position: relative;
    }
    .input-value.active::after {
      content: 'x';
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* capture offscreen */
    .capture-container{display:none;position:absolute;left:-9999px;width:615px;height:850px;background:#000 url('img/9372e881397e867c7f2bca42c3fdd1e9.jpg') repeat; border:var(--container-border-width) solid #9801e7;border-radius:var(--container-border-radius);overflow:hidden;padding:10px;display:flex;flex-direction:column;align-items:center;}
    .capture-container .capture-image{width:100%;min-height:var(--image-min-height);object-fit:cover;}
    .capture-container #captureIconImg{width:var(--icon-width);height:var(--icon-height);image-rendering: pixelated;}

    /* scaled container (final render) */
    .scaled-capture-container{
      position:absolute;left:-9999px;top:-9999px;width:615px;height:850px;background:#000 url('img/9372e881397e867c7f2bca42c3fdd1e9.jpg') repeat; border:var(--scaled-container-border-width) solid #9801e7;border-radius:var(--scaled-container-border-radius);overflow:hidden;padding:var(--scaled-container-padding);display:flex;flex-direction:column;align-items:center;justify-content:space-between;}
    }
    .scaled-capture-container .capture-image{width:100%;min-height:var(--scaled-image-min-height);object-fit:cover;}
    .scaled-capture-container .capture-data{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:var(--scaled-container-gap);text-align:center;width:100%;flex-grow:1;}
    .scaled-capture-container #scaledCaptureIconImg{width:var(--scaled-icon-width);height:var(--scaled-icon-height);display:inline-block;image-rendering: pixelated;}
    .scaled-capture-container .telegram-link{font-size:var(--scaled-telegram-font-size);text-decoration:none;}
    .scaled-capture-container .rarity-block{padding:var(--scaled-rarity-padding-y) var(--scaled-rarity-padding-x);font-size:var(--scaled-rarity-font-size);border:var(--scaled-rarity-border-width) solid transparent;border-top-right-radius:var(--scaled-rarity-border-radius);border-bottom-left-radius:var(--scaled-rarity-border-radius);}
    .scaled-capture-container .rarity-block span{text-shadow:var(--scaled-rarity-text-shadow-x) var(--scaled-rarity-text-shadow-y) 0 rgba(0,0,0,0.5);}
    .scaled-capture-container .author-text{font-size:var(--scaled-author-font-size);}
    .scaled-capture-container .cost-wrapper{display:flex;align-items:center;gap:var(--scaled-cost-gap);}
    .scaled-capture-container .price-label{font-size:var(--scaled-price-font-size);}
    .scaled-capture-container #scaledCaptureCostText{font-size:var(--scaled-cost-font-size);display:inline-block;}

    /* container border colors by rarity */
    .preview-container.rare,.capture-container.rare,.scaled-capture-container.rare{border-color:#e800fe;}
    .preview-container.super-rare,.capture-container.super-rare,.scaled-capture-container.super-rare{border-color:#69e0e4;}
    .preview-container.ultimate,.capture-container.ultimate,.scaled-capture-container.ultimate{border-color:#db2a24;}
    .preview-container.spotlight,.capture-container.spotlight,.scaled-capture-container.spotlight{border-color:#0027d5;}
    .preview-container.conquest-reward,.capture-container.conquest-reward,.scaled-capture-container.conquest-reward{border-color:#1a821a;}
    .preview-container.bundle,.capture-container.bundle,.scaled-capture-container.bundle{border-color:#c2bb0a;}
    .preview-container.webshop-reward,.capture-container.webshop-reward,.scaled-capture-container.webshop-reward{border-color:#db8216;}

    /* –ê–¥–∞–ø—Ç–∏–≤ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .wrapper {
        flex-direction: column;
        align-items: center;
        gap: 15px;
      }

      .preview-container {
        min-width: 100%;
        max-width: 100%;
        padding: 15px;
      }

      .preview-image {
        min-height: 250px;
      }

      .controls {
        grid-template-columns: 1fr;
        gap: 10px;
        width: 100%;
      }

      .controls input,
      .controls button,
      .controls label,
      .controls select,
      .custom-file-button {
        padding: 8px 12px; /* –£–º–µ–Ω—å—à–∞–µ–º –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        font-size: 14px;
        height: 45px; /* –ß—É—Ç—å –º–µ–Ω—å—à–µ –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏ */
      }

      .input-value.active::after {
        right: 10px;
        width: 18px;
        height: 18px;
      }

      .rarity-block {
        padding: 4px 12px;
        font-size: 14px;
      }

      .author-text {
        font-size: 16px;
      }

      .cost-wrapper {
        gap: 4px;
      }

      .price-label, #costText {
        font-size: 16px;
      }

      #iconImg {
        width: 18px;
        height: 18px;
      }

      .telegram-link {
        font-size: 16px;
      }
    }

    @media (max-width: 480px) {
      .preview-container {
        padding: 10px;
      }

      .preview-image {
        min-height: 200px;
      }

      .controls input,
      .controls button,
      .controls label,
      .controls select,
      .custom-file-button {
        padding: 6px 10px; /* –ï—â–µ –º–µ–Ω—å—à–µ –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        font-size: 12px;
        height: 40px;
      }

      .rarity-block {
        padding: 3px 10px;
        font-size: 12px;
      }

      .author-text {
        font-size: 14px;
      }

      .price-label, #costText {
        font-size: 14px;
      }

      #iconImg {
        width: 16px;
        height: 16px;
      }

      .telegram-link {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <!-- Preview -->
    <div class="preview-container rare" id="previewContainer">
      <div class="preview-data">
        <div id="rarityText" class="rarity-block rare"><span>Rare</span></div>
      </div>
      <img id="previewImage" class="preview-image" src="./img/card-preview.webp" alt="–ü—Ä–µ–≤—å—é –∫–∞—Ä—Ç—ã" />

      <div class="preview-data">
        <div id="authorText" class="author-text">
          <span class="author-label">–•—É–¥–æ–∂–Ω–∏–∫:</span>
          <span class="author-name">Kim Jacinto</span>
        </div>

        <div id="costWrapper" class="cost-wrapper">
          <span class="price-label">–¶–µ–Ω–∞:</span>
          <span id="costText">1200</span>
          <img id="iconImg" src="./img/icons/gold-icon.webp" alt="–ò–∫–æ–Ω–∫–∞ –≤–∞–ª—é—Ç—ã" />
        </div>

        <a class="telegram-link" href="#" target="_blank">@tgmarvelsnap</a>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls-wrapper">
      <div class="controls">
        <div class="file-input-wrapper">
          <button type="button" class="custom-file-button">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
          <input id="imageInput" type="file" accept="image/*" style="display:none" />
        </div>

        <div class="input-value">
          <input id="priceInput" type="text" placeholder="–¶–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1200)" />
        </div>

        <div class="input-value">
          <input id="rarityInput" type="text" placeholder="–†–µ–¥–∫–æ—Å—Ç—å (–º–æ–∂–Ω–æ –≤–ø–∏—Å–∞—Ç—å —Å–≤–æ—é)" />
        </div>

        <div class="rarity-style-select">
          <label for="rarityStyleSelect">–°—Ç–∏–ª—å —Ä–µ–¥–∫–æ—Å—Ç–∏:</label>
          <select id="rarityStyleSelect">
            <option value="rare">Rare</option>
            <option value="super-rare">Super Rare</option>
            <option value="ultimate">Ultimate</option>
            <option value="spotlight">Spotlight</option>
            <option value="conquest-reward">Conquest Reward</option>
            <option value="bundle">Bundle</option>
            <option value="webshop-reward">Webshop Reward</option>
          </select>
        </div>

        <div class="input-value">
          <input id="authorInput" type="text" placeholder="–•—É–¥–æ–∂–Ω–∏–∫" />
        </div>

        <label><input id="priceLabelCheckbox" type="checkbox" checked /> –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å ¬´–¶–µ–Ω–∞:¬ª</label>
        <label><input id="iconCheckbox" type="checkbox" checked /> –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–∫–æ–Ω–∫—É</label>

        <select id="iconSelect">
          <option value="./img/icons/gold-icon.webp">–ó–æ–ª–æ—Ç–æ</option>
          <option value="./img/icons/usd-icon2.webp">–î–æ–ª–ª–∞—Ä—ã</option>
          <option value="./img/icons/tokens_big.webp">–¢–æ–∫–µ–Ω—ã</option>
          <option value="./img/icons/credits_big1.webp">–ö—Ä–µ–¥–∏—Ç—ã</option>
        </select>

        <label><input id="authorLabelCheckbox" type="checkbox" checked /> –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å ¬´–•—É–¥–æ–∂–Ω–∏–∫:¬ª</label>

        <button id="resetButton" type="button">–°–±—Ä–æ—Å–∏—Ç—å</button>
        <button id="downloadButton" type="button">–°–∫–∞—á–∞—Ç—å PNG</button>
        <button id="downloadGifButton" type="button" disabled>–°–∫–∞—á–∞—Ç—å GIF</button>
      </div>
    </div>
  </div>

  <!-- Capture container (hidden offscreen) -->
  <div class="capture-container rare" id="captureContainer">
    <div class="capture-data">
      <div id="captureRarityText" class="rarity-block rare"><span>Rare</span></div>
    </div>
    <img id="captureImage" class="capture-image" src="./img/card-preview.webp" alt="capture" />

    <div class="capture-data">
      <div id="captureAuthorText" class="author-text">
        <span class="author-label">–•—É–¥–æ–∂–Ω–∏–∫:</span>
        <span class="author-name">Kim Jacinto</span>
      </div>

      <div id="captureCostWrapper" class="cost-wrapper">
        <span class="price-label">–¶–µ–Ω–∞:</span>
        <span id="captureCostText">1200</span>
        <img id="captureIconImg" src="./img/icons/gold-icon.webp" alt="icon" />
      </div>

      <a class="telegram-link" href="#" target="_blank">@tgmarvelsnap</a>
    </div>
  </div>

  <!-- Scaled container for output (615x850) -->
  <div id="scaledCaptureContainer" class="scaled-capture-container rare">
    <div class="capture-data">
      <div id="scaledRarityText" class="rarity-block rare"><span>Rare</span></div>
    </div>
    <img id="scaledCaptureImage" class="capture-image" src="./img/card-preview.webp" alt="scaled" />

    <div class="capture-data">
      <div id="scaledAuthorText" class="author-text">
        <span class="author-label">–•—É–¥–æ–∂–Ω–∏–∫:</span>
        <span class="author-name">Kim Jacinto</span>
      </div>

      <div id="scaledCostWrapper" class="cost-wrapper">
        <span class="price-label">–¶–µ–Ω–∞:</span>
        <span id="scaledCaptureCostText">1200</span>
        <img id="scaledCaptureIconImg" src="./img/icons/gold-icon.webp" alt="icon" />
      </div>

      <a class="telegram-link" href="#" target="_blank">@tgmarvelsnap</a>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      'use strict';

      const $id = id => document.getElementById(id);
      const $sel = sel => document.querySelector(sel);

      function capitalizeWords(str = ''){return String(str).trim().split(/\s+/).map(w=>w.charAt(0).toUpperCase()+w.slice(1).toLowerCase()).join(' ')}
      function getDeclension(number, words=['–∑–æ–ª–æ—Ç–æ','–∑–æ–ª–æ—Ç–∞','–∑–æ–ª–æ—Ç–∞']){
        const n=Math.abs(Number(number))%100; const n1=n%10; if(n>10 && n<20) return words[2]; if(n1>1 && n1<5) return words[1]; if(n1===1) return words[0]; return words[2];
      }
      function safeSetText(el, text){ if(el) el.textContent = text }
      function safeSetSrc(el, src){ if(el) el.src = src }
      function safeSetDisplay(el, value){ if(el) el.style.display = value }

      // DOM
      const previewContainer = $id('previewContainer');
      const captureContainer = $id('captureContainer');
      const scaledCaptureContainer = $id('scaledCaptureContainer');

      const imageInput = $id('imageInput');
      const previewImage = $id('previewImage');
      const rarityInput = $id('rarityInput');
      const authorInput = $id('authorInput');
      const priceInput = $id('priceInput');
      const iconCheckbox = $id('iconCheckbox');
      const iconSelect = $id('iconSelect');
      const authorLabelCheckbox = $id('authorLabelCheckbox');
      const priceLabelCheckbox = $id('priceLabelCheckbox');
      const rarityText = $id('rarityText');
      const authorLabel = $sel('.author-label');
      const authorName = $sel('.author-name');
      const costText = $id('costText');
      const iconImg = $id('iconImg');
      const priceLabel = $sel('.price-label');
      const resetButton = $id('resetButton');
      const downloadButton = $id('downloadButton');
      const costWrapper = $id('costWrapper');
      const customFileButton = $sel('.custom-file-button');
      const rarityStyleSelect = $id('rarityStyleSelect');

      // capture elements
      const captureImage = $id('captureImage');
      const captureRarityText = $id('captureRarityText');
      const captureAuthorLabel = $sel('#captureAuthorText .author-label');
      const captureAuthorName = $sel('#captureAuthorText .author-name');
      const captureCostText = $id('captureCostText');
      const captureIconImg = $id('captureIconImg');
      const capturePriceLabel = $sel('#captureCostWrapper .price-label');
      const captureCostWrapper = $id('captureCostWrapper');

      const scaledImage = $id('scaledCaptureImage');
      const scaledRarityText = $id('scaledRarityText');
      const scaledAuthorLabel = $sel('#scaledAuthorText .author-label');
      const scaledAuthorName = $sel('#scaledAuthorText .author-name');
      const scaledCostText = $id('scaledCaptureCostText');
      const scaledIconImg = $id('scaledCaptureIconImg');
      const scaledPriceLabel = $sel('#scaledCostWrapper .price-label');
      const scaledCostWrapper = $id('scaledCostWrapper');

      // defaults
      const defaultPrice = '1200';
      const defaultAuthor = 'Kim Jacinto';
      const suffixes = {
        './img/icons/gold-icon.webp':['–∑–æ–ª–æ—Ç–æ','–∑–æ–ª–æ—Ç–∞','–∑–æ–ª–æ—Ç–∞'],
        './img/icons/usd-icon2.webp':['–¥–æ–ª–ª–∞—Ä','–¥–æ–ª–ª–∞—Ä–∞','–¥–æ–ª–ª–∞—Ä–æ–≤'],
        './img/icons/tokens_big.webp':['–∂–µ—Ç–æ–Ω','–∂–µ—Ç–æ–Ω–∞','–∂–µ—Ç–æ–Ω–æ–≤'],
        './img/icons/credits_big1.webp':['–∫—Ä–µ–¥–∏—Ç','–∫—Ä–µ–¥–∏—Ç–∞','–∫—Ä–µ–¥–∏—Ç–æ–≤']
      };
      const rarityStyles = { rare:'Rare','super-rare':'Super Rare', ultimate:'Ultimate', spotlight:'Spotlight', 'conquest-reward':'Conquest Reward', bundle:'Bundle', 'webshop-reward':'Webshop Reward' };
      const allowedRarityClasses = Object.keys(rarityStyles);

      // Helpers
      function setImgSrcSafe(img, src){
        if(!img) return;
        try{ img.removeAttribute('crossorigin'); }catch{};
        if(typeof src === 'string' && /^https?:\/\//i.test(src)){
          try{ img.crossOrigin = 'anonymous'; }catch{}
        }
        img.src = src || '';
      }

      function renderCost(){
        const base = (priceInput && priceInput.value !== undefined) ? String(priceInput.value).trim() : defaultPrice;
        const textValue = base || defaultPrice;
        const number = parseInt(String(base).replace(/\s+/g, ''), 10) || 0;

        if(iconCheckbox && iconCheckbox.checked){
          // When icon visible ‚Äî show only number + icon (no declension word)
          safeSetText(costText, textValue);
          if(iconSelect && iconImg) setImgSrcSafe(iconImg, iconSelect.value);
          if(iconImg) iconImg.style.display = 'inline-block';
        } else {
          // No icon ‚Äî show number + declension word
          const suffixArray = (iconSelect && suffixes[iconSelect.value]) ? suffixes[iconSelect.value] : ['–∑–æ–ª–æ—Ç–æ','–∑–æ–ª–æ—Ç–∞','–∑–æ–ª–æ—Ç–∞'];
          safeSetText(costText, textValue + ' ' + getDeclension(number, suffixArray));
          if(iconImg) iconImg.style.display = 'none';
        }
        updateCostWrapperVisibility();
      }

      function renderAuthor(){
        const name = (authorInput && authorInput.value) ? authorInput.value : defaultAuthor;
        safeSetText(authorName, capitalizeWords(name));
      }

      function updateLabelsVisibility(){
        if(authorLabel) authorLabel.style.display = (authorLabelCheckbox && authorLabelCheckbox.checked) ? 'inline' : 'none';
        if(priceLabel) priceLabel.style.display = (priceLabelCheckbox && priceLabelCheckbox.checked) ? 'inline' : 'none';
        updateCostWrapperVisibility();
      }

      function updateCostWrapperVisibility(){
        const hasPrice = (priceInput && String(priceInput.value || '').trim() !== '');
        if(costWrapper){
          costWrapper.style.display = (hasPrice || (priceLabelCheckbox && priceLabelCheckbox.checked) || (iconCheckbox && iconCheckbox.checked)) ? 'flex' : 'none';
        }
      }

      function toggleActiveClass(input){ if(!input) return; const parent=input.closest('.input-value'); if(parent) parent.classList.toggle('active', String(input.value||'').trim() !== ''); }

      function clearInput(input){ if(!input) return; input.value=''; toggleActiveClass(input); input.dispatchEvent(new Event('input',{bubbles:true})); if(input===rarityInput && rarityStyleSelect){ const style = rarityStyleSelect.value || 'rare'; if(rarityText) safeSetText(rarityText.querySelector('span'), rarityStyles[style]); if(captureRarityText) safeSetText(captureRarityText.querySelector('span'), rarityStyles[style]); if(scaledRarityText) safeSetText(scaledRarityText.querySelector('span'), rarityStyles[style]); } }

      function updateRarityStyle(){
        const style = (rarityStyleSelect && rarityStyleSelect.value) ? rarityStyleSelect.value : 'rare';
        if(rarityText) rarityText.className = 'rarity-block ' + style;
        if(captureRarityText) captureRarityText.className = 'rarity-block ' + style;
        if(scaledRarityText) scaledRarityText.className = 'rarity-block ' + style;

        [previewContainer, captureContainer, scaledCaptureContainer].forEach(container=>{
          if(!container) return;
          allowedRarityClasses.forEach(c=>container.classList.remove(c));
          container.classList.add(style);
        });

        if(rarityInput && String(rarityInput.value||'').trim()===''){
          const mapped = rarityStyles[style] || capitalizeWords(style);
          if(rarityText) safeSetText(rarityText.querySelector('span'), mapped);
          if(captureRarityText) safeSetText(captureRarityText.querySelector('span'), mapped);
          if(scaledRarityText) safeSetText(scaledRarityText.querySelector('span'), mapped);
        }
      }

      // update capture copies
      function updateCaptureContainer(){
        // images (use safe setter for cross-origin safety)
        if(previewImage && captureImage) setImgSrcSafe(captureImage, previewImage.src || '');
        if(previewImage && scaledImage) setImgSrcSafe(scaledImage, previewImage.src || '');

        // rarity
        if(rarityText && captureRarityText){ const spanText = rarityText.querySelector('span') ? rarityText.querySelector('span').textContent : ''; safeSetText(captureRarityText.querySelector('span'), spanText); captureRarityText.className = rarityText.className; }
        if(rarityText && scaledRarityText){ const spanText = rarityText.querySelector('span') ? rarityText.querySelector('span').textContent : ''; safeSetText(scaledRarityText.querySelector('span'), spanText); scaledRarityText.className = rarityText.className; }

        // author
        if(authorLabel && captureAuthorLabel) captureAuthorLabel.style.display = authorLabel.style.display;
        if(authorName && captureAuthorName) captureAuthorName.textContent = authorName.textContent || '';
        if(authorLabel && scaledAuthorLabel) scaledAuthorLabel.style.display = authorLabel.style.display;
        if(authorName && scaledAuthorName) scaledAuthorName.textContent = authorName.textContent || '';

        // price
        if(costText && captureCostText) captureCostText.textContent = costText.textContent || '';
        if(iconImg && captureIconImg) setImgSrcSafe(captureIconImg, iconImg.src || '');
        if(priceLabel && capturePriceLabel) capturePriceLabel.style.display = priceLabel.style.display;
        if(costWrapper && captureCostWrapper) captureCostWrapper.style.display = costWrapper.style.display;

        if(costText && scaledCostText) scaledCostText.textContent = costText.textContent || '';
        if(iconImg && scaledIconImg) setImgSrcSafe(scaledIconImg, iconImg.src || '');
        if(priceLabel && scaledPriceLabel) scaledPriceLabel.style.display = priceLabel.style.display;
        if(costWrapper && scaledCostWrapper) scaledCostWrapper.style.display = costWrapper.style.display;

        // telegram link
        const previewTelegram = $sel('.preview-container .telegram-link');
        const captureTelegram = $sel('#captureContainer .telegram-link');
        const scaledTelegram = $sel('#scaledCaptureContainer .telegram-link');
        if(previewTelegram && captureTelegram) captureTelegram.textContent = previewTelegram.textContent;
        if(previewTelegram && scaledTelegram) scaledTelegram.textContent = previewTelegram.textContent;
      }

      // Wait for images + fonts
      function waitForImages(container, timeout = 4000){
        const imgs = Array.from(container.querySelectorAll('img'));
        if(imgs.length===0) return Promise.resolve();
        return Promise.all(imgs.map(img=> new Promise(resolve=>{
          if(img.complete && img.naturalWidth && img.naturalHeight) return resolve();
          const t = setTimeout(() => resolve(), timeout);
          img.addEventListener('load', ()=>{ clearTimeout(t); resolve(); }, {once:true});
          img.addEventListener('error', ()=>{ clearTimeout(t); resolve(); }, {once:true});
        })));
      }

      // Events
      if(customFileButton && imageInput){
        customFileButton.addEventListener('click', e=>{ e.preventDefault(); imageInput.click(); });
      }

      [rarityInput, authorInput, priceInput].filter(Boolean).forEach(input=>{
        input.addEventListener('input', ()=>{ toggleActiveClass(input); updatePreview(); });
        toggleActiveClass(input);
      });

      document.querySelectorAll('.input-value').forEach(wrapper=>{
        wrapper.addEventListener('click', e=>{
          const input = wrapper.querySelector('input'); if(!input) return;
          if(wrapper.classList.contains('active') && (e.offsetX > wrapper.offsetWidth - 30)){
            clearInput(input);
          }
        });
      });

      if(imageInput){
        imageInput.addEventListener('change', e=>{
          const file = e.target.files && e.target.files[0]; if(!file) return;
          const url = URL.createObjectURL(file);
          if(previewImage) { previewImage.removeAttribute('crossorigin'); previewImage.src = url; }
          if(captureImage) { captureImage.removeAttribute('crossorigin'); captureImage.src = url; }
          if(scaledImage) { scaledImage.removeAttribute('crossorigin'); scaledImage.src = url; }
          updateCaptureContainer();
        });
      }

      if(iconCheckbox){ iconCheckbox.addEventListener('change', ()=>{ if(iconSelect) iconSelect.disabled = !iconCheckbox.checked; updatePreview(); }); }
      if(iconSelect) iconSelect.addEventListener('change', updatePreview);
      if(authorLabelCheckbox) authorLabelCheckbox.addEventListener('change', updatePreview);
      if(priceLabelCheckbox) priceLabelCheckbox.addEventListener('change', updatePreview);
      if(rarityStyleSelect) rarityStyleSelect.addEventListener('change', ()=>{ updateRarityStyle(); updatePreview(); });

      function updatePreview(){
        if(rarityInput && String(rarityInput.value||'').trim() !== ''){
          const text = capitalizeWords(rarityInput.value);
          if(rarityText && rarityText.querySelector('span')) safeSetText(rarityText.querySelector('span'), text);
          if(captureRarityText && captureRarityText.querySelector('span')) safeSetText(captureRarityText.querySelector('span'), text);
          if(scaledRarityText && scaledRarityText.querySelector('span')) safeSetText(scaledRarityText.querySelector('span'), text);
        }
        renderCost();
        renderAuthor();
        updateLabelsVisibility();
        updateCaptureContainer();
      }

      // init
      try{ renderCost(); renderAuthor(); updateLabelsVisibility(); updateRarityStyle(); updateCaptureContainer(); }catch(err){ console.warn('Init warning:', err); }

      if(resetButton){
        resetButton.addEventListener('click', ()=>{
          if(imageInput) imageInput.value='';
          if(previewImage) previewImage.src='./img/card-preview.webp';
          if(captureImage) captureImage.src='./img/card-preview.webp';
          if(scaledImage) scaledImage.src='./img/card-preview.webp';
          if(rarityInput) rarityInput.value='';
          if(rarityStyleSelect) rarityStyleSelect.value='rare';
          if(rarityText && rarityText.querySelector('span')) safeSetText(rarityText.querySelector('span'), rarityStyles['rare']);
          if(authorInput) authorInput.value='';
          if(priceInput) priceInput.value='';
          if(iconCheckbox) iconCheckbox.checked = true;
          if(iconSelect){ iconSelect.disabled = false; iconSelect.value = './img/icons/gold-icon.webp'; }
          if(authorLabelCheckbox) authorLabelCheckbox.checked = true;
          if(priceLabelCheckbox) priceLabelCheckbox.checked = true;
          updateRarityStyle(); renderCost(); renderAuthor(); updateLabelsVisibility(); updateCaptureContainer();
          [rarityInput, authorInput, priceInput].filter(Boolean).forEach(input=> toggleActiveClass(input));
        });
      }

      // Download PNG
      if(downloadButton){
        downloadButton.addEventListener('click', async ()=>{
          if(!scaledCaptureContainer) return;
          updateCaptureContainer();

          // Temporarily set styles for rendering
          const scaled = scaledCaptureContainer;
          const originalDisplay = scaled.style.display;
          const originalPosition = scaled.style.position;
          const originalLeft = scaled.style.left;
          const originalTop = scaled.style.top;

          scaled.style.display = 'flex';
          scaled.style.position = 'absolute';
          scaled.style.left = '-9999px';
          scaled.style.top = '-9999px';

          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –ø–µ—Ä–µ–¥ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º
          scaled.style.width = '615px';
          scaled.style.height = '850px';

          // Wait for fonts + images
          try{
            const fontsReady = (document.fonts && document.fonts.ready) ? document.fonts.ready : Promise.resolve();
            await Promise.all([fontsReady, waitForImages(scaledCaptureContainer, 4000)]);
          }catch(e){ console.warn('Resources load timeout', e); }

          html2canvas(scaledCaptureContainer, {
            scale: 2,
            width: 615,
            height: 850,
            backgroundColor: null,
            useCORS: true,
            windowWidth: 615,
            windowHeight: 850
          }).then(canvas=>{
            const now = new Date();
            const pad = n => String(n).padStart(2,'0');
            const hours = pad(now.getHours()); const minutes = pad(now.getMinutes()); const day = pad(now.getDate()); const month = pad(now.getMonth()+1); const year = now.getFullYear();
            let artist = (authorName && authorName.textContent) ? authorName.textContent : 'Unknown'; artist = String(artist).replace(/[<>"'\/\\|?*]/g,'').trim();
            const fileName = `Artist_-_${artist}_${hours}-${minutes}_${day}.${month}.${year}.png`.replace(/\s+/g,'_');
            const link = document.createElement('a'); link.download = fileName; link.href = canvas.toDataURL('image/png', 1.0); link.click();
          }).catch(err=>{ console.error('html2canvas error:', err); }).finally(()=>{
            scaled.style.display = originalDisplay;
            scaled.style.position = originalPosition;
            scaled.style.left = originalLeft;
            scaled.style.top = originalTop;
            scaled.style.width = '';
            scaled.style.height = '';
          });
        });
      }

    });
  </script>
</body>
</html>
